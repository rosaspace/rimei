{% extends "container/base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>ğŸ“¦ Add Invoice</h2>
    
    <!-- ä¸Šä¼  PDF -->
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" id="pdf-file" accept="application/pdf" required>
        <button type="submit" class="btn btn-primary">ä¸Šä¼ å¹¶è§£æ</button>
    </form>

    <hr>

    <!-- è§£æç»“æœ -->
    <div id="result" style="display: none;">
        <h4>è§£æå†…å®¹ï¼š</h4>
        <textarea id="pdf-content" class="form-control" rows="10"></textarea>
        <button id="save-btn" class="btn btn-success mt-3">âœ… ä¿å­˜æ•°æ®</button>
    </div>
</div>

<script>
document.getElementById("upload-form").onsubmit = function(event) {
    event.preventDefault();
    let fileInput = document.getElementById("pdf-file").files[0];
    
    if (!fileInput) {
        alert("è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶");
        return;
    }

    let formData = new FormData();
    formData.append("pdf_file", fileInput);

    fetch("{% url 'upload_pdf' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + data.error);
        } else {
            document.getElementById("pdf-content").value = data.content;
            document.getElementById("result").style.display = "block";
            if (data.file_name) {
                document.getElementById("save-btn").dataset.filename = data.file_name;
            } else {
                alert("âŒ æ–‡ä»¶åæœªå®šä¹‰");
            }
        }
    });
};

document.getElementById("save-btn").onclick = function() {
    let content = document.getElementById("pdf-content").value;
    let fileName = this.dataset.filename;

    fetch("{% url 'save_container' %}", {
        method: "POST",
        body: new URLSearchParams({ "file_name": fileName, "content": content }),
        headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + data.error);
        } else {
            alert("âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼");
        }
    });
};
</script>
{% endblock %}
