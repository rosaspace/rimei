{% extends "container/base.html" %}
{% block content %}

<h4 class="mb-4">Print Order</h4>
    <div class="row">
        <div class="col-md-2 mb-3">
            <button class="btn btn-primary  w-100" id="printDetail">Print Detail</a>
        </div>
        <div class="col-md-2 mb-3">
            <button class="btn btn-primary  w-100" id="printLabel">Print Label</a>
        </div>
    </div>

<hr class="my-4 border-2 opacity-100">

<h4>ðŸ§¾ Edit Container</h4>

<div class="container-form">
    <form id="edit-container-form">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Container ID</label>
                <div class="container-id-display">{{ container.container_id }}</div>
                <input type="hidden" id="container-id" value="{{ container.container_id }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="pickup-number" class="form-label">Pickup Number</label>
                <input type="text" class="form-control" id="pickup-number" name="pickup_number" 
                       value="{{ container.pickup_number }}">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="railway-date" class="form-label">Railway Date</label>
                <input type="date" class="form-control" id="railway-date" name="railway_date" 
                       value="{{ container.railway_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="pickup-date" class="form-label">Pickup Date</label>
                <input type="date" class="form-control" id="pickup-date" name="pickup_date" 
                       value="{{ container.pickup_date|date:'Y-m-d' }}">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="delivery-date" class="form-label">Delivery Date</label>
                <input type="date" class="form-control" id="delivery-date" name="delivery_date" 
                       value="{{ container.delivery_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="empty-date" class="form-label">Empty Date</label>
                <input type="date" class="form-control" id="empty-date" name="empty_date" 
                       value="{{ container.empty_date|date:'Y-m-d' }}">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="plts" class="form-label">PLTS</label>
                <input type="number" class="form-control" id="plts" name="plts" 
                       value="{{ container.plts }}" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="container-pdf" class="form-label">Container PDF</label>
                {% if container.container_pdfname %}
                    <p class="text-muted">Current file: {{ container.container_pdfname }}</p>
                {% endif %}
                <input type="file" class="form-control" id="container-pdf" name="container_pdf" accept="application/pdf">
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Update Container</button>
            <a href="{% url 'container' %}" class="btn btn-secondary ms-2">Back</a>
        </div>
    </form>
</div>
<hr class="my-4 border-2 opacity-100">

<!-- æ·»åŠ Containeré¡¹ç›®è¡¨æ ¼ -->
<div class="row mt-4">
    <div class="col-12">
        <h5>Order Items</h5>
        <table class="table table-bordered"  id="orderTable">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td>
                        <select class="form-control product-select">
                            <option value="{{ item.product.id }}" selected>{{ item.product.name }}</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" class="form-control quantity-input" value="{{ item.quantity }}" min="1"></td>
                    <td><button class="btn btn-danger btn-sm remove-row">Remove</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-primary mt-2" id="addRow">Add New Line</button>
        <button class="btn btn-success mt-2" id="saveContainerItems">Save</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("edit-container-form").onsubmit = function(event) {
            event.preventDefault();
            
            let formData = new FormData();
            formData.append("container_id", document.getElementById("container-id").value);
            formData.append("pickup_number", document.getElementById("pickup-number").value);
            
            // æ·»åŠ  PLTS å­—æ®µ
            formData.append("plts", document.getElementById("plts").value);
        
            // æ·»åŠ æ—¥æœŸå­—æ®µ
            const dateFields = ["railway-date", "pickup-date", "delivery-date", "empty-date"];
            dateFields.forEach(field => {
                const value = document.getElementById(field).value;
                if (value) {
                    formData.append(field.replace("-", "_"), value);
                }
            });
            
            // æ·»åŠ PDFæ–‡ä»¶ï¼ˆå¦‚æžœæœ‰æ–°ä¸Šä¼ ï¼‰
            const containerPdf = document.getElementById("container-pdf").files[0];
            if (containerPdf) {
                formData.append("container_pdf", containerPdf);
            }

            fetch("{% url 'edit_container' container.container_id %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("âŒ Update failed: " + data.error);
                } else {
                    alert("âœ… Container updated successfully!");
                    window.location.href = "{% url 'container' %}";  // æ›´æ–°æˆåŠŸåŽè¿”å›žåˆ—è¡¨é¡µ
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("âŒ An error occurred while updating the container.");
            });
        };

        const containerID = '{{ container.container_id }}';
        // æ‰“å°è¯¦å•
        document.getElementById('printDetail').addEventListener('click', function() {
            window.open(`/print_container_detail/${containerID}/`, '_blank');
        });

        // æ‰“å°æ ‡ç­¾
        document.getElementById('printLabel').addEventListener('click', function() {
            window.open(`/print_container_label/${containerID}/`, '_blank');
        });

        // ä¿å­˜æ¡ç›®
        document.getElementById('saveContainerItems').addEventListener('click', function(e) {
            e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤

            const rows = document.querySelectorAll('tbody tr');
            let orderitems = [];

            console.log("è¡¨æ ¼è¡Œæ•°:", rows.length);
            console.log("Container ID:", containerID);

            rows.forEach(row => {
                const itemName = row.children[0].textContent.trim();
                const quantity = parseInt(row.children[1].textContent.trim()) || 0;
                console.log("--- ", itemName, quantity);

                orderitems.push({
                    item: itemName,
                    qty: quantity
                });
            });

            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('orderitems', JSON.stringify(orderitems));        

            // æ£€æŸ¥FormDataå†…å®¹
            for (let pair of formData.entries()) {
                // console.log(pair[0] + ': ' + pair[1]);
            }

            // å‘é€æ•°æ®åˆ°åŽç«¯
            fetch('/save_containeritems/${containerID}/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => {
                // Check if the response is OK (status in the range 200-299)
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // Parse the JSON response
            })
            .then(html => {
                // å°†è¿”å›žçš„ HTML æ’å…¥åˆ°é¡µé¢ä¸­
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the order');
            });
        });
    });

    $(document).ready(function () {
        // æ·»åŠ æ–°è¡Œ
        $("#addRow").click(function () {
            let newRow = `
                <tr>
                    <td>
                        <select class="form-control product-select">
                            <option value="">Select Product</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" class="form-control quantity-input" min="1"></td>
                    <td><button class="btn btn-danger btn-sm remove-row">Remove</button></td>
                </tr>
            `;
            $("#orderTable tbody").append(newRow);
        });

        // åˆ é™¤è¡Œ
        $(document).on("click", ".remove-row", function () {
            $(this).closest("tr").remove();
        });
    });
    
</script>

{% endblock %}